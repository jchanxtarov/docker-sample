version: "3.3"
services:
  mysql:
    build: ./mysql # 特にすることがなければ下に変更して、Dockerfileは削除して良い
    image: mysql:5.7
    restart: always
    environment:
      MYSQL_DATABASE: flask_app
      MYSQL_USER: flask
      MYSQL_PASSWORD: flask # TODO: 置き場所変更したい
      MYSQL_HOST: localhost
      MYSQL_ROOT_PASSWORD: root
      TZ: 'Asia/Tokyo'
    # command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_bin
    volumes: # DockerfileのADDと同じ役割をしている気がする
      - ./mysql/data:/var/lib/mysql # データの永続化
      - ./mysql/sql:/docker-entrypoint-initdb.d # 初期化で実行するSQLをここに置くdockerの決まり
      - ./mysql/my.cnf:/etc/mysql/conf.d/my.cnf # mysqlの設定ファイル
      # - ./mysql/log:/var/log/mysql # ログの出力先(my.cnfとダブっているのが気になる)
    ports:
      - 3306:3306
    
  app:
    build: ./src
    volumes:
      - ./src:/app
      # - ~/.cache:/root/.cache # TODO: cacheも使ったappにしたい
    ports:
      - 5001:5001
    links: # depends_on: でも良さそう
      - mysql
    tty: true # コンテナが起動しっぱなしになるのでデバッグしたい時とかに便利
    environment: 
        FLASK_APP: run.py # python run.py を flask run に置き換えている
        FLASK_ENV: development
    command: flask run
    # command: make wait-mysql | flask run -h 0.0.0.

  swagger:
    image: swaggerapi/swagger-ui
    container_name: app_swagger
    volumes:
      - ./docs:/docs
    environment:
      - SWAGGER_JSON=/docs/swagger.yaml
    ports:
    - 5050:8080
